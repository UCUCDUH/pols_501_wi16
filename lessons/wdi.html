<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Jeffrey Arnold" />

<meta name="date" content="2016-01-24" />

<title>Application: Downloading and Cleaning WDI data</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/cerulean.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<link rel="stylesheet"
      href="libs/highlight/textmate.css"
      type="text/css" />
<script src="libs/highlight/highlight.js"></script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<p>
<strong>POL S/CS&amp;SS 501, University of Washington, Winter 2016</strong>
</p>

$$
\DeclareMathOperator{\mean}{mean}
\DeclareMathOperator{\var}{var}
\DeclareMathOperator{\E}{E}
\DeclareMathOperator{\MSE}{MSE}
\DeclareMathOperator{\Bias}{Bias}
\DeclareMathOperator{\SE}{se}
\DeclareMathOperator{\SD}{sd}
\DeclareMathOperator{\argmin}{argmin}
\DeclareMathOperator{\argmax}{argmax}
$$

<div id="header">
<h1 class="title">Application: Downloading and Cleaning WDI data</h1>
<h4 class="author"><em>Jeffrey Arnold</em></h4>
<h4 class="date"><em>January 24, 2016</em></h4>
</div>


<p>This lesson is a practical example of using R to clean and tidy the World Bank <a href="http://data.worldbank.org/data-catalog/world-development-indicators">World Development Indicators</a> data which is</p>
<p>The primary World Bank collection of development indicators, compiled from officially-recognized international sources. It presents the most current and accurate global development data available, and includes national, regional and global estimates.<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a></p>
<pre class="r"><code>library(&quot;dplyr&quot;)
library(&quot;tidyr&quot;)
library(&quot;ggplot2&quot;)
library(&quot;stringr&quot;)</code></pre>
<p>We first need to download the WDI data. This could be done manually by downloading the file and unzipping it, but these steps can also be automated with R functions. Download the zip file,</p>
<pre class="r"><code>download.file(&quot;http://databank.worldbank.org/data/download/WDI_csv.zip&quot;,
              &quot;data/WDI_csv.zip&quot;)</code></pre>
<p>This may take a few minutes since it is in the tens of megabytes. Unzip it to <code>data/WDI</code> using the function <code>unzip()</code>,</p>
<pre class="r"><code>unzip(&quot;data/WDI_csv.zip&quot;, exdir = &quot;data/WDI&quot;)</code></pre>
<p>Let’s see what files were included in the zip file</p>
<pre class="r"><code>dir(&quot;data/WDI&quot;)</code></pre>
<pre><code>## [1] &quot;WDI_Country.csv&quot;     &quot;WDI_CS_Notes.csv&quot;    &quot;WDI_Data.csv&quot;       
## [4] &quot;WDI_Description.csv&quot; &quot;WDI_Footnotes.csv&quot;   &quot;WDI_Series.csv&quot;     
## [7] &quot;WDI_ST_Notes.csv&quot;</code></pre>
<p>The <code>dir</code> function lists the files in a directory.</p>
<p>The files of interest for this analysis are <code>WDI_Country</code>, and <code>WDI_Data</code>, which has the series.</p>
<pre class="r"><code>wdi_country &lt;- read.csv(&quot;data/WDI/WDI_Country.csv&quot;, stringsAsFactors = FALSE,
                        fileEncoding = &quot;cp1252&quot;) %&gt;%
  tbl_df()
wdi_data &lt;- read.csv(&quot;data/WDI/WDI_Data.csv&quot;, stringsAsFactors = FALSE,
                     fileEncoding = &quot;cp1252&quot;) %&gt;%
  tbl_df()
wdi_series &lt;- read.csv(&quot;data/WDI/WDI_Series.csv&quot;, stringsAsFactors = FALSE,
                     fileEncoding = &quot;cp1252&quot;) %&gt;%
  tbl_df()</code></pre>
<p>The dataset <code>WDI_Country</code> contains country-level data, including names of the country, its income group, region, lending category, and many other technocratic details. Encoding is the specific method which characters are stored; the option <code>fileEncoding</code> is needed to prevent an error message.</p>
<pre class="r"><code>glimpse(wdi_country)</code></pre>
<pre><code>## Observations: 247
## Variables: 31
## $ Country.Code                                      (chr) &quot;AFG&quot;, &quot;ALB&quot;...
## $ Short.Name                                        (chr) &quot;Afghanistan...
## $ Table.Name                                        (chr) &quot;Afghanistan...
## $ Long.Name                                         (chr) &quot;Islamic Sta...
## $ X2.alpha.code                                     (chr) &quot;AF&quot;, &quot;AL&quot;, ...
## $ Currency.Unit                                     (chr) &quot;Afghan afgh...
## $ Special.Notes                                     (chr) &quot;Fiscal year...
## $ Region                                            (chr) &quot;South Asia&quot;...
## $ Income.Group                                      (chr) &quot;Low income&quot;...
## $ WB.2.code                                         (chr) &quot;AF&quot;, &quot;AL&quot;, ...
## $ National.accounts.base.year                       (chr) &quot;2002/03&quot;, &quot;...
## $ National.accounts.reference.year                  (chr) &quot;&quot;, &quot;1996&quot;, ...
## $ SNA.price.valuation                               (chr) &quot;Value added...
## $ Lending.category                                  (chr) &quot;IDA&quot;, &quot;IBRD...
## $ Other.groups                                      (chr) &quot;HIPC&quot;, &quot;&quot;, ...
## $ System.of.National.Accounts                       (chr) &quot;Country use...
## $ Alternative.conversion.factor                     (chr) &quot;&quot;, &quot;&quot;, &quot;&quot;, ...
## $ PPP.survey.year                                   (chr) &quot;&quot;, &quot;Rolling...
## $ Balance.of.Payments.Manual.in.use                 (chr) &quot;&quot;, &quot;IMF Bal...
## $ External.debt.Reporting.status                    (chr) &quot;Actual&quot;, &quot;A...
## $ System.of.trade                                   (chr) &quot;General tra...
## $ Government.Accounting.concept                     (chr) &quot;Consolidate...
## $ IMF.data.dissemination.standard                   (chr) &quot;General Dat...
## $ Latest.population.census                          (chr) &quot;1979&quot;, &quot;201...
## $ Latest.household.survey                           (chr) &quot;Multiple In...
## $ Source.of.most.recent.Income.and.expenditure.data (chr) &quot;Integrated ...
## $ Vital.registration.complete                       (chr) &quot;&quot;, &quot;Yes&quot;, &quot;...
## $ Latest.agricultural.census                        (chr) &quot;2013/14&quot;, &quot;...
## $ Latest.industrial.data                            (int) NA, 2011, 20...
## $ Latest.trade.data                                 (int) 2013, 2013, ...
## $ Latest.water.withdrawal.data                      (int) 2000, 2006, ...</code></pre>
<p>The dataset <code>WDI_Data</code> contains the WDI data,</p>
<pre class="r"><code>glimpse(wdi_data)</code></pre>
<pre><code>## Observations: 333,560
## Variables: 60
## $ Country.Name   (chr) &quot;Arab World&quot;, &quot;Arab World&quot;, &quot;Arab World&quot;, &quot;Arab...
## $ Country.Code   (chr) &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;...
## $ Indicator.Name (chr) &quot;2005 PPP conversion factor, GDP (LCU per inter...
## $ Indicator.Code (chr) &quot;PA.NUS.PPP.05&quot;, &quot;PA.NUS.PRVT.PP.05&quot;, &quot;EG.ELC.A...
## $ X1960          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1961          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1962          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1963          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1964          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1965          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1966          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1967          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1968          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1969          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1970          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1971          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1972          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1973          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1974          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1975          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1976          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1977          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1978          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1979          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1980          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1981          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1982          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1983          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1984          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1985          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1986          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1987          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1988          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1989          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1990          (dbl) NA, NA, 7.544751e+01, 5.868064e+01, 9.184235e+0...
## $ X1991          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1992          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1993          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1994          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1995          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1996          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1997          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1998          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X1999          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X2000          (dbl) NA, NA, 7.953695e+01, 6.586906e+01, 9.165462e+0...
## $ X2001          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X2002          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X2003          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X2004          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X2005          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X2006          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X2007          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X2008          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X2009          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X2010          (dbl) NA, NA, 8.434222e+01, 7.196990e+01, 9.382846e+0...
## $ X2011          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X2012          (dbl) NA, NA, 8.627075e+01, 7.390983e+01, 9.515141e+0...
## $ X2013          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X2014          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ X2015          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...</code></pre>
<p>However, it is an inconvenient and hardly tidy format with each column a year, and each row a country-variable. In the csv file, the columns are named “1960”, “1961”, …, but in the data frame they are named “X1960”, “X1961”, …. This is because “1960” is an invalid name for an R variable, so R creates a valid name by prefixing it with an “X”.</p>
<p>In order to get this data in a form usable for analysis, the first step is to reshape <code>WDI_data</code> so each row is a (country, year). We can do that with the <strong>tidyr</strong> function <code>gather</code>. We use the <code>matches</code> function to only match the variables beginning with “X”, which are the year variables.<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></p>
<pre class="r"><code>wdi_data_long &lt;-
  wdi_data %&gt;%
  select(-Indicator.Name) %&gt;%
  gather(year, value, matches(&quot;^X&quot;))
glimpse(wdi_data_long)</code></pre>
<pre><code>## Observations: 18,679,360
## Variables: 5
## $ Country.Name   (chr) &quot;Arab World&quot;, &quot;Arab World&quot;, &quot;Arab World&quot;, &quot;Arab...
## $ Country.Code   (chr) &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;...
## $ Indicator.Code (chr) &quot;PA.NUS.PPP.05&quot;, &quot;PA.NUS.PRVT.PP.05&quot;, &quot;EG.ELC.A...
## $ year           (chr) &quot;X1960&quot;, &quot;X1960&quot;, &quot;X1960&quot;, &quot;X1960&quot;, &quot;X1960&quot;, &quot;X...
## $ value          (dbl) NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...</code></pre>
<p>However, the variable <code>year</code> still has an “X” prefix. We will remove the “X” using the function <code>str_replace</code> from the <a href="https://cran.r-project.org/web/packages/stringr/vignettes/stringr.html">stringr</a> package, and convert it to an integer vector.<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a></p>
<pre class="r"><code>wdi_data_long &lt;- mutate(wdi_data_long,
                        year = as.integer(str_replace(year, &quot;X&quot;, &quot;&quot;)))</code></pre>
<p>Now reshape the dataset so each variable is a column,</p>
<pre class="r"><code>wdi_data_long &lt;- wdi_data_long %&gt;%
  spread(Indicator.Code, value)
dim(wdi_data_long)</code></pre>
<pre><code>## [1] 13888  1348</code></pre>
<p>Now each row of the dataset is a (country, year) observation and each column is a variable.</p>
<p>Let’s merge the data with the country data to add their regions and income levels. The variable <code>Country.Code</code> in both data frames are their keys.</p>
<pre class="r"><code>wdi_data_long &lt;-
  wdi_data_long %&gt;%
  left_join(select(wdi_country, Country.Code, Region, Income.Group),
            by = &quot;Country.Code&quot;)</code></pre>
<p>The WDI data include “country” observations that are actually aggregations of countries, for example, “OECD members”, “High income”, “Sub-Saharan Africa (all income levels)”. These observations have empty values for <code>Region</code>, and we can filter them out using that.</p>
<pre class="r"><code>wdi_data_long &lt;- wdi_data_long %&gt;%
  filter(Region != &quot;&quot;)</code></pre>
<p>Let’s use this data to make a plot. For example, the average CO2 emissions per capita by decade by income group,</p>
<pre class="r"><code>ggplot(select(wdi_data_long, Income.Group, year,
              Country.Code, EN.ATM.CO2E.PC) %&gt;%
         filter(!is.na(EN.ATM.CO2E.PC)) %&gt;%
         mutate(decade = year %/% 10 * 10) %&gt;%
         group_by(decade, Country.Code) %&gt;%
         summarise(EN.ATM.CO2E.PC = mean(EN.ATM.CO2E.PC),
                   Income.Group = first(Income.Group)),
       aes(x = factor(decade),
           y = EN.ATM.CO2E.PC,
           color = Income.Group)) +
  geom_boxplot() +
  scale_colour_discrete(&quot;Income Group&quot;) +
  ylab(&quot;CO2 Emissions per capita&quot;) +
  xlab(&quot;&quot;)</code></pre>
<p><img src="wdi_files/figure-html/unnamed-chunk-13-1.png" title="" alt="" width="672" /></p>
<!--
For more on strings and regular expressions see [Introduction to stringr](https://cran.r-project.org/web/packages/stringr/vignettes/stringr.html) and the *R for Data Science* chapter [Strings](http://r4ds.had.co.nz/strings.html).
-->
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p><a href="http://data.worldbank.org/data-catalog/world-development-indicators" class="uri">http://data.worldbank.org/data-catalog/world-development-indicators</a><a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>The leading “^” means to match the start of the string. This is an example of a regular expression, which is a powerful method for pattern matching. See <a href="http://r4ds.had.co.nz/strings.html">R for Data Science</a> for more.<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>The <strong>stringr</strong> package contains many functions for processing strings. See the <a href="https://cran.r-project.org/web/packages/stringr/vignettes/stringr.html">introduction</a> or the <em>R for Data Science</em> chapter on <a href="http://r4ds.had.co.nz/strings.html">Strings</a> for more information on it.<a href="#fnref3">↩</a></p></li>
</ol>
</div>

<hr>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
R code is licensed under a <a href="https://www.r-project.org/Licenses/BSD_2_clause">BSD 2-clause</a> license.

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
